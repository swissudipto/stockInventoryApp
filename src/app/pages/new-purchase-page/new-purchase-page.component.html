<div class="p-fluid p-3">
  <h2 class="text-2xl font-semibold mb-4">ðŸ§¾ New Purchase Entry</h2>

  <!-- Vendor Info -->
  <p-card header="Vendor Details" class="mb-4">
    <div class="p-grid p-formgrid p-fluid">
      <div class="p-col-12 p-md-3">
        <label for="vendor">Vendor</label>
        <p-dropdown
          [options]="vendors"
          optionLabel="name"
          formControlName="vendorId"
          placeholder="Select Vendor"
        ></p-dropdown>
      </div>

      <div class="p-col-12 p-md-3">
        <label for="invoiceNo">Invoice No</label>
        <input pInputText formControlName="invoiceNo" placeholder="Enter invoice number" />
      </div>

      <div class="p-col-12 p-md-3">
        <label for="purchaseDate">Purchase Date</label>
        <p-calendar
          formControlName="purchaseDate"
          [showIcon]="true"
          dateFormat="dd M yy"
        ></p-calendar>
      </div>

      <div class="p-col-12 p-md-3">
        <label for="remarks">Remarks</label>
        <input pInputText formControlName="remarks" placeholder="Optional" />
      </div>
    </div>
  </p-card>

  <!-- Product Section -->
  <p-card header="Product Details" class="mb-4">
    <div class="flex justify-end mb-2">
      <button
        pButton
        label="Add Product"
        icon="pi pi-plus"
        class="p-button-sm"
        (click)="openProductDialog()"
      ></button>
    </div>

    <p-table
      [value]="purchaseItems"
      dataKey="id"
      responsiveLayout="scroll"
      styleClass="p-datatable-sm"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Product</th>
          <th>Qty</th>
          <th>Unit Price</th>
          <th>Total</th>
          <th>Serials</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-item let-i="rowIndex">
        <tr>
          <td>{{ item.productName }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.unitPrice | currency: 'INR' }}</td>
          <td>{{ item.unitPrice * item.quantity | currency: 'INR' }}</td>
          <td>
            <a class="text-blue-500 cursor-pointer" (click)="openSerialDialog(item)">
              {{ item.serialNumbers.length || 0 }} entered
            </a>
          </td>
          <td>
            <button pButton icon="pi pi-pencil" class="p-button-text p-button-sm" (click)="editProduct(item, i)"></button>
            <button pButton icon="pi pi-trash" class="p-button-text p-button-danger p-button-sm" (click)="removeProduct(i)"></button>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <div class="text-right font-semibold mt-3">
      Total: {{ getPurchaseTotal() | currency: 'INR' }}
    </div>
  </p-card>

  <!-- Save Buttons -->
  <div class="flex justify-end gap-3 mt-4">
    <button pButton label="Cancel" class="p-button-outlined p-button-danger" routerLink="/purchases"></button>
    <button pButton label="Save Purchase" icon="pi pi-save" (click)="savePurchase()"></button>
  </div>

  <!-- Add/Edit Product Dialog -->
  <p-dialog
    header="{{ editMode ? 'Edit Product' : 'Add Product' }}"
    [(visible)]="productDialog"
    [modal]="true"
    [style]="{ width: '40vw' }"
  >
    <div class="p-fluid">
      <div class="p-field">
        <label>Product</label>
        <p-dropdown
          [options]="productList"
          optionLabel="name"
          [(ngModel)]="tempProduct.productName"
          placeholder="Select Product"
        ></p-dropdown>
      </div>
      <div class="p-field">
        <label>Quantity</label>
        <input type="number" pInputText [(ngModel)]="tempProduct.quantity" />
      </div>
      <div class="p-field">
        <label>Unit Price</label>
        <input type="number" pInputText [(ngModel)]="tempProduct.unitPrice" />
      </div>
    </div>
    <p-footer>
      <button pButton label="Cancel" class="p-button-text" (click)="productDialog=false"></button>
      <button pButton label="Save" (click)="saveProduct()"></button>
    </p-footer>
  </p-dialog>

  <!-- Serial Numbers Dialog -->
  <p-dialog
    header="Enter Serial Numbers"
    [(visible)]="serialDialog"
    [modal]="true"
    [style]="{ width: '40vw' }"
  >
    <div class="p-fluid">
      <div *ngFor="let serial of tempSerials; let i = index" class="flex align-items-center gap-2 mb-2">
        <input pInputText [(ngModel)]="tempSerials[i]" placeholder="Enter Serial Number" />
        <button
          pButton
          icon="pi pi-times"
          class="p-button-rounded p-button-text p-button-danger"
          (click)="removeSerial(i)"
        ></button>
      </div>
      <button pButton label="Add Serial" icon="pi pi-plus" class="p-button-text" (click)="addSerial()"></button>
    </div>
    <p-footer>
      <button pButton label="Cancel" class="p-button-text" (click)="serialDialog=false"></button>
      <button pButton label="Save" (click)="saveSerials()"></button>
    </p-footer>
  </p-dialog>
</div>
